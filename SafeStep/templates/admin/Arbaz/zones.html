{% extends "base.html" %}

{% block title %}Zones Management - SafeStep{% endblock %}

{% block body_class %}admin-page{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <h1><i class="fas fa-map-marker-alt me-3"></i>Zones Management</h1>
            <p class="text-muted">Manage safety zones across all users</p>
        </div>
        <div class="header-buttons">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createZoneModal">
                <i class="fas fa-plus me-2"></i>Create Zone
            </button>
            <button class="btn btn-outline-secondary" onclick="exportZonesData()">
                <i class="fas fa-download me-2"></i>Export Data
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="totalZones">0</div>
                <div class="metric-label">Total Zones</div>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="activeUsers">0</div>
                <div class="metric-label">Active Users</div>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="activeZones">0</div>
                <div class="metric-label">Active Zones</div>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-content">
                <div class="metric-value" id="avgRadius">0m</div>
                <div class="metric-label">Avg Radius</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="admin-card">
        <div class="card-header">
            <h5><i class="fas fa-filter me-2"></i>Filters</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">User</label>
                    <select class="form-select" id="userFilter">
                        <option value="">All Users</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Zone Type</label>
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="home">Home</option>
                        <option value="work">Work</option>
                        <option value="school">School</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Actions</label>
                    <div class="d-grid">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-2"></i>Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Zones Table -->
    <div class="admin-card">
        <div class="card-header">
            <h5><i class="fas fa-list me-2"></i>All Zones</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="admin-table" id="zonesTable">
                    <thead>
                        <tr>
                            <th>Zone Name</th>
                            <th>User</th>
                            <th>Location</th>
                            <th>Radius</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="zonesTableBody">
                        <!-- Zones will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Zone Distribution Chart -->
    <div class="admin-card">
        <div class="card-header">
            <h5><i class="fas fa-chart-pie me-2"></i>Zone Distribution</h5>
        </div>
        <div class="card-body">
            <canvas id="zoneDistributionChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Create Zone Modal -->
<div class="modal fade" id="createZoneModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Create New Zone
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createZoneForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Zone Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">User</label>
                                <select class="form-select" name="user_id" required>
                                    <option value="">Select User</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Latitude</label>
                                <input type="number" class="form-control" name="latitude" step="any" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Longitude</label>
                                <input type="number" class="form-control" name="longitude" step="any" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Radius (meters)</label>
                                <input type="number" class="form-control" name="radius" min="10" max="10000" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Create Zone
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Zone Modal -->
<div class="modal fade" id="editZoneModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Zone
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editZoneForm">
                <input type="hidden" name="zone_id" id="editZoneId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Zone Name</label>
                                <input type="text" class="form-control" name="name" id="editZoneName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="is_active" id="editZoneStatus">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="editZoneDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Latitude</label>
                                <input type="number" class="form-control" name="latitude" id="editZoneLatitude" step="any" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Longitude</label>
                                <input type="number" class="form-control" name="longitude" id="editZoneLongitude" step="any" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Radius (meters)</label>
                                <input type="number" class="form-control" name="radius" id="editZoneRadius" min="10" max="10000" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Zone
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let zoneDistributionChart;

// Initialize the zones page
document.addEventListener('DOMContentLoaded', function() {
    loadZonesData();
    loadUsersForFilter();
    initializeZoneDistributionChart();
});

function loadZonesData() {
    fetch('/api/admin/zones')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMetrics(data.metrics);
                populateZonesTable(data.zones);
                updateZoneDistributionChart(data.distribution);
            }
        })
        .catch(error => {
            console.error('Error loading zones data:', error);
        });
}

function updateMetrics(metrics) {
    document.getElementById('totalZones').textContent = metrics.total_zones || 0;
    document.getElementById('activeUsers').textContent = metrics.active_users || 0;
    document.getElementById('activeZones').textContent = metrics.active_zones || 0;
    document.getElementById('avgRadius').textContent = (metrics.avg_radius || 0) + 'm';
}

function populateZonesTable(zones) {
    const tbody = document.getElementById('zonesTableBody');
    tbody.innerHTML = '';

    zones.forEach(zone => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${zone.name}</td>
            <td>${zone.user_name}</td>
            <td>${zone.latitude.toFixed(4)}, ${zone.longitude.toFixed(4)}</td>
            <td>${zone.radius}m</td>
            <td><span class="status-badge ${zone.is_active ? 'status-active' : 'status-inactive'}">${zone.is_active ? 'Active' : 'Inactive'}</span></td>
            <td>${new Date(zone.created_at).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editZone(${zone.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteZone(${zone.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function loadUsersForFilter() {
    fetch('/api/admin/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const userFilter = document.getElementById('userFilter');
                const createZoneUserSelect = document.querySelector('#createZoneForm select[name="user_id"]');
                
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.first_name} ${user.last_name} (${user.username})`;
                    
                    userFilter.appendChild(option.cloneNode(true));
                    createZoneUserSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
        });
}

function initializeZoneDistributionChart() {
    const ctx = document.getElementById('zoneDistributionChart').getContext('2d');
    zoneDistributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Home', 'Work', 'School', 'Other'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    '#4CAF50',
                    '#2196F3',
                    '#FF9800',
                    '#9C27B0'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateZoneDistributionChart(distribution) {
    if (zoneDistributionChart) {
        zoneDistributionChart.data.datasets[0].data = [
            distribution.home || 0,
            distribution.work || 0,
            distribution.school || 0,
            distribution.other || 0
        ];
        zoneDistributionChart.update();
    }
}

function applyFilters() {
    const userFilter = document.getElementById('userFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;

    const params = new URLSearchParams();
    if (userFilter) params.append('user_id', userFilter);
    if (statusFilter) params.append('status', statusFilter);
    if (typeFilter) params.append('type', typeFilter);

    fetch(`/api/admin/zones?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateZonesTable(data.zones);
            }
        })
        .catch(error => {
            console.error('Error applying filters:', error);
        });
}

function editZone(zoneId) {
    fetch(`/api/admin/zones/${zoneId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const zone = data.zone;
                document.getElementById('editZoneId').value = zone.id;
                document.getElementById('editZoneName').value = zone.name;
                document.getElementById('editZoneDescription').value = zone.description || '';
                document.getElementById('editZoneLatitude').value = zone.latitude;
                document.getElementById('editZoneLongitude').value = zone.longitude;
                document.getElementById('editZoneRadius').value = zone.radius;
                document.getElementById('editZoneStatus').value = zone.is_active.toString();
                
                new bootstrap.Modal(document.getElementById('editZoneModal')).show();
            }
        })
        .catch(error => {
            console.error('Error loading zone details:', error);
        });
}

function deleteZone(zoneId) {
    if (confirm('Are you sure you want to delete this zone?')) {
        fetch(`/api/admin/zones/${zoneId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadZonesData();
            } else {
                alert('Error deleting zone: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting zone:', error);
        });
    }
}

function exportZonesData() {
    fetch('/api/admin/zones/export')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'zones_data.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            console.error('Error exporting zones data:', error);
        });
}

// Form submissions
document.getElementById('createZoneForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/api/admin/zones', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createZoneModal')).hide();
            this.reset();
            loadZonesData();
        } else {
            alert('Error creating zone: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error creating zone:', error);
    });
});

document.getElementById('editZoneForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const zoneId = formData.get('zone_id');
    
    fetch(`/api/admin/zones/${zoneId}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editZoneModal')).hide();
            loadZonesData();
        } else {
            alert('Error updating zone: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error updating zone:', error);
    });
});
</script>
{% endblock %}
