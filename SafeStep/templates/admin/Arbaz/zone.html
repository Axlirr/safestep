{% extends "base.html" %}

{% block title %}Zones Management - SafeStep{% endblock %}

{% block body_class %}admin-page{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
  /* Layout */
  .zone-header { background: linear-gradient(135deg,#667eea,#764ba2); color:#fff; padding:2rem 0; margin-bottom:2rem; border-radius:0 0 20px 20px; }
  .zone-title { font-size:2rem; font-weight:800; }
  .map-container { height:500px; border-radius:12px; border:1px solid #e2e8f0; }

  /* Cards */
  .zone-card, .filter-card { background:#fff; border-radius:12px; padding:1rem; border:1px solid #e2e8f0; box-shadow:0 6px 18px rgba(0,0,0,.06); }
  .stats-card { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; border:none; border-radius:12px; padding:1rem; text-align:center; }
  .stats-number { font-size:1.6rem; font-weight:800; }

  /* Badges */
  .zone-type-badge { padding:.35rem .6rem; border-radius:999px; font-weight:700; font-size:.75rem; }
  .zone-type-safe { background:#38a169; color:#fff; }
  .zone-type-danger { background:#e53e3e; color:#fff; }

  /* Buttons */
  .btn-create { background:linear-gradient(135deg,#48bb78,#38ef7d); color:#fff; border:none; font-weight:700; border-radius:10px; }
  .btn-create:hover { filter:brightness(.95); }

  /* Inputs */
  .search-box { border-radius:10px; border:2px solid #e2e8f0; padding:.6rem .75rem; }
  .sg-bounds-info { background:#e6fffa; border:1px solid #81e6d9; color:#234e52; padding:.6rem; border-radius:8px; font-size:.9rem; }

  /* List */
  .zone-item { border:1px solid #e2e8f0; border-radius:10px; padding:.75rem; }
</style>
{% endblock %}
{% block content %}
<div class="admin-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <h1><i class="fas fa-map-marker-alt me-3"></i>Zones Management</h1>
            <p class="text-muted">Manage safety zones across all users</p>
        </div>
        <div class="header-buttons">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createZoneModal">
                <i class="fas fa-plus me-2"></i>Create Zone
            </button>
        </div>
    </div>

  <div class="container-fluid">
  <!-- Stats -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3"><div class="stats-card"><div class="stats-number" id="totalZones">0</div><div>Total Zones</div></div></div>
    <div class="col-6 col-md-3"><div class="stats-card"><div class="stats-number" id="safeZones">0</div><div>Safe Zones</div></div></div>
    <div class="col-6 col-md-3"><div class="stats-card"><div class="stats-number" id="dangerZones">0</div><div>Danger Zones</div></div></div>
    <div class="col-6 col-md-3"><div class="stats-card"><div class="stats-number" id="activeEvents">0</div><div>Recent Events</div></div></div>
  </div>

    <div class="filter-card mb-4">
    <div class="row g-3 align-items-center">
      <div class="col-md-4"><input id="searchZones" class="form-control search-box" placeholder="Search zones…" /></div>
      <div class="col-md-3">
        <select id="filterType" class="form-select search-box">
          <option value="">All Types</option>
          <option value="safe">Safe Zones</option>
          <option value="danger">Danger Zones</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="filterStatus" class="form-select search-box">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
      <div class="col-md-2"><button class="btn btn-outline-primary w-100" id="btnRefresh"><i class="fas fa-sync-alt me-2"></i>Refresh</button></div>
    </div>
  </div>
    <div class="row g-4">
    <!-- Map -->
    <div class="col-lg-8">
      <div class="zone-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Singapore Zone Map</h5>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" id="btnCenter"><i class="fas fa-crosshairs me-1"></i>Center</button>
            <button class="btn btn-outline-primary" id="btnFit"><i class="fas fa-expand me-1"></i>Fit All</button>
          </div>
        </div>
        <div class="sg-bounds-info"><i class="fas fa-info-circle me-2"></i><strong>Coverage:</strong> All zones are restricted to Singapore bounds (1.16°–1.47°N, 103.6°–104.0°E)</div>
        <div id="zoneMap" class="map-container"></div>
      </div>
    </div>
<!-- List -->
    <div class="col-lg-4">
      <div class="zone-card">
        <h5 class="mb-3">Active Zones</h5>
        <div id="zonesList" class="d-grid gap-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- Create / Edit Modal -->
<div class="modal fade" id="zoneModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="zoneModalTitle">Create New Zone</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="zoneForm">
          <input type="hidden" id="zoneId" name="zoneId" />

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Zone Name</label>
              <input type="text" class="form-control" name="name" required />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Zone Type</label>
              <select class="form-select" name="zone_type" required>
                <option value="">Select Type</option>
                <option value="safe">Safe Zone</option>
                <option value="danger">Danger Zone</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Description</label>
              <textarea class="form-control" name="description" rows="3"></textarea>
            </div>
            <div class="col-12">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="is_active" id="isActiveSwitch" checked />
                <label class="form-check-label" for="isActiveSwitch">Active Zone</label>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold mb-1">Draw Zone on Map</label>
              <div class="text-muted small mb-2">Use the drawing tools to create circular or polygon zones.</div>
              <div id="drawMap" class="map-container" style="height:320px"></div>
            </div>
            <div class="col-12" id="coordinateInputs" style="display:none">
              <div class="row g-3">
                <div class="col-md-4"><label class="form-label">Center Latitude</label><input type="number" step="0.000001" class="form-control" name="center_lat" readonly /></div>
                <div class="col-md-4"><label class="form-label">Center Longitude</label><input type="number" step="0.000001" class="form-control" name="center_lng" readonly /></div>
                <div class="col-md-4"><label class="form-label">Radius (m)</label><input type="number" class="form-control" name="radius_m" readonly /></div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="btnSaveZone">Save Zone</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Confirm Delete</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p>Are you sure you want to delete this zone? This action cannot be undone.</p>
        <div class="alert alert-warning mb-0"><i class="fas fa-exclamation-triangle me-2"></i>This will also remove associated geofence events.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">Delete Zone</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}



{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
(() => {
  // ===== Config =====
  const API = {
    list: '/api/admin/zones',
    create: '/api/admin/zones',
    update: id => `/api/admin/zones/${id}`,
    remove: id => `/api/admin/zones/${id}`,
    events: '/api/admin/geofence-events?limit=10'
  };
  const SG_BOUNDS = L.latLngBounds([1.16,103.6],[1.47,104.0]);

  // ===== State =====
  let map, drawMap, zonesLayer, drawnItems;
  let allZones = [];        // original zones
  let filteredZones = [];   // current view
  let currentGeometry = null;
  let deleteId = null;

  // ===== Elements =====
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  // ===== Init =====
  document.addEventListener('DOMContentLoaded', () => {
    bindUI();
    initMap();
    loadZones();
    loadEventsCount();
    getUserLocationMarker();
  });

  function bindUI() {
    $('#btnCreate').addEventListener('click', () => openCreateModal());
    $('#btnRefresh').addEventListener('click', () => refreshZones());
    $('#btnCenter').addEventListener('click', () => centerOnSG());
    $('#btnFit').addEventListener('click', () => fitAllZones());
    $('#btnSaveZone').addEventListener('click', onSaveZone);
    $('#searchZones').addEventListener('keyup', applyFilters);
    $('#filterType').addEventListener('change', applyFilters);
    $('#filterStatus').addEventListener('change', applyFilters);
    $('#confirmDelete').addEventListener('click', onConfirmDelete);
  }

  // ===== Map =====
  function initMap() {
    map = L.map('zoneMap', { zoomControl: true }).setView([1.3521,103.8198], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(map);
    map.setMaxBounds(SG_BOUNDS); map.options.minZoom = 10; map.on('drag', () => map.panInsideBounds(SG_BOUNDS, { animate: false }));
    zonesLayer = L.layerGroup().addTo(map);
  }

  function initDrawMap() {
    if (drawMap) { drawMap.remove(); }
    drawMap = L.map('drawMap').setView([1.3521,103.8198], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(drawMap);
    drawMap.setMaxBounds(SG_BOUNDS); drawMap.options.minZoom = 10;

    drawnItems = new L.FeatureGroup();
    drawMap.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems, remove: true },
      draw: {
        polygon: { allowIntersection: false },
        circle: true, rectangle: false, polyline: false, marker: false, circlemarker: false
      }
    });
    drawMap.addControl(drawControl);

    drawMap.on(L.Draw.Event.CREATED, e => {
      drawnItems.clearLayers();
      drawnItems.addLayer(e.layer);

      if (e.layer instanceof L.Circle) {
        const c = e.layer.getLatLng();
        const r = Math.round(e.layer.getRadius());
        currentGeometry = { type: 'Point', coordinates: [c.lng, c.lat] };
        $('[name="center_lat"]').value = c.lat; $('[name="center_lng"]').value = c.lng; $('[name="radius_m"]').value = r;
        $('#coordinateInputs').style.display = '';
      } else if (e.layer instanceof L.Polygon) {
        const latlngs = e.layer.getLatLngs()[0];
        const coords = latlngs.map(ll => [ll.lng, ll.lat]);
        coords.push(coords[0]); // close polygon
        currentGeometry = { type: 'Polygon', coordinates: [coords] };
        // centroid for reference
        const cLat = latlngs.reduce((s,ll)=>s+ll.lat,0)/latlngs.length;
        const cLng = latlngs.reduce((s,ll)=>s+ll.lng,0)/latlngs.length;
        $('[name="center_lat"]').value = cLat; $('[name="center_lng"]').value = cLng; $('[name="radius_m"]').value = '';
        $('#coordinateInputs').style.display = '';
      }
    });

    drawMap.on(L.Draw.Event.DELETED, () => { currentGeometry = null; $('#coordinateInputs').style.display='none'; });
  }

  // ===== Data =====
  async function loadZones() {
    setListLoading(true);
    try {
      const res = await fetch(API.list);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      // Accept FeatureCollection or legacy shapes
      let features = [];
      if (data && data.type === 'FeatureCollection' && Array.isArray(data.features)) {
        features = data.features;
      } else if (Array.isArray(data)) {
        features = data.map(z => ({ type:'Feature', properties:z.properties||z, geometry:z.geometry||null }));
      } else if (data && data.success && Array.isArray(data.zones)) {
        features = data.zones.map(z => ({ type:'Feature', properties:z.properties||z, geometry:z.geometry||null }));
      }

      // Keep only valid items with a name
      allZones = features.filter(f => (f.properties||{}).name);
      filteredZones = [...allZones];

      renderZones();
      renderList();
      updateStats();
    } catch (err) {
      notify('Error loading zones', 'danger');
      allZones = filteredZones = [];
      renderZones();
      renderList();
      updateStats();
    } finally { setListLoading(false); }
  }

  async function loadEventsCount() {
    try {
      const r = await fetch(API.events); const j = await r.json();
      $('#activeEvents').textContent = (j && j.events) ? j.events.length : 0;
    } catch { $('#activeEvents').textContent = '0'; }
  }

  // ===== Rendering =====
  function renderZones() {
    zonesLayer.clearLayers();
    filteredZones.forEach(f => {
      const p = f.properties || {}; const g = f.geometry;
      let layer = null, color = (p.zone_type === 'danger') ? '#e53e3e' : '#38a169';

      if (g && g.type === 'Point' && Array.isArray(g.coordinates)) {
        const center = [g.coordinates[1], g.coordinates[0]];
        const radius = p.radius_m || p.radius || 50;
        layer = L.circle(center, { radius, color, fillColor: color, fillOpacity:.2, weight:2 });
      } else if (g && g.type === 'Polygon' && g.coordinates && g.coordinates[0]) {
        const coords = g.coordinates[0].map(c => [c[1], c[0]]);
        layer = L.polygon(coords, { color, fillColor: color, fillOpacity:.2, weight:2 });
      } else if (p.center_lat && p.center_lng && (p.radius_m || p.radius)) {
        layer = L.circle([p.center_lat, p.center_lng], { radius: p.radius_m || p.radius, color, fillColor: color, fillOpacity:.2, weight:2 });
      } else if (p.latitude && p.longitude && (p.radius_m || p.radius)) {
        layer = L.circle([p.latitude, p.longitude], { radius: p.radius_m || p.radius, color, fillColor: color, fillOpacity:.2, weight:2 });
      }

      if (!layer) return;

      const statusBadge = p.is_active ? 'success' : 'secondary';
      const created = p.created_at ? new Date(p.created_at).toLocaleDateString() : 'Unknown';
      layer.bindPopup(`
        <div class="text-center">
          <h6 class="mb-1">${escapeHtml(p.name)}</h6>
          <div class="mb-2">
            <span class="badge zone-type-${p.zone_type}">${(p.zone_type||'').toUpperCase()}</span>
            <span class="badge bg-${statusBadge} ms-1">${p.is_active? 'Active':'Inactive'}</span>
          </div>
          <div class="small text-muted">Status: ${escapeHtml(p.status||'approved')} · Created: ${created}</div>
        </div>
      `);
      zonesLayer.addLayer(layer);
    });
  }

  function renderList() {
    const wrap = $('#zonesList');
    if (!filteredZones.length) { wrap.innerHTML = '<div class="text-muted text-center">No zones found</div>'; return; }

    wrap.innerHTML = filteredZones.map((f, idx) => {
      const p = f.properties || {}; const id = p.id ?? idx;
      const typeClass = (p.zone_type === 'danger') ? 'zone-type-danger' : 'zone-type-safe';
      const statusClass = (p.status === 'pending') ? 'warning' : (p.status === 'rejected') ? 'danger' : 'success';
      const activeClass = p.is_active ? 'success' : 'secondary';
      const created = p.created_at ? new Date(p.created_at).toLocaleDateString() : 'Unknown';
      const desc = p.description ? escapeHtml(p.description) : '—';
      return `
        <div class="zone-item d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="fw-semibold">${escapeHtml(p.name)}</div>
            <div class="mt-1">
              <span class="badge ${typeClass}">${(p.zone_type||'').toUpperCase()}</span>
              <span class="badge bg-${statusClass} ms-1">${p.status||'approved'}</span>
              <span class="badge bg-${activeClass} ms-1">${p.is_active? 'Active':'Inactive'}</span>
            </div>
            <div class="small text-muted mt-1">${desc}</div>
            <div class="small text-muted">Created: ${created}</div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" data-action="edit" data-id="${id}"><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${id}"><i class="fas fa-trash"></i></button>
          </div>
        </div>`;
    }).join('');

    wrap.querySelectorAll('button[data-action]').forEach(btn => {
      const id = btn.getAttribute('data-id');
      btn.addEventListener('click', () => {
        const action = btn.getAttribute('data-action');
        if (action === 'edit') openEditModal(id);
        if (action === 'delete') openDeleteModal(id);
      });
    });
  }

  function updateStats() {
    const safe = filteredZones.filter(f => (f.properties||{}).zone_type === 'safe').length;
    const danger = filteredZones.filter(f => (f.properties||{}).zone_type === 'danger').length;
    $('#totalZones').textContent = filteredZones.length;
    $('#safeZones').textContent = safe;
    $('#dangerZones').textContent = danger;
  }

  // ===== Filters =====
  function applyFilters() {
    const q = ($('#searchZones').value || '').toLowerCase();
    const type = $('#filterType').value;
    const status = $('#filterStatus').value; // active / inactive / ''

    filteredZones = allZones.filter(f => {
      const p = f.properties || {};
      const matchesText = !q || (p.name||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q);
      const matchesType = !type || p.zone_type === type;
      const matchesStatus = !status || (status === 'active' ? !!p.is_active : !p.is_active);
      return matchesText && matchesType && matchesStatus;
    });

    renderZones();
    renderList();
    updateStats();
  }

  function refreshZones() { loadZones(); notify('Zones refreshed','success'); }
  function centerOnSG() { map.setView([1.3521,103.8198], 11); }
  function fitAllZones() {
    const group = new L.featureGroup();
    filteredZones.forEach(f => {
      const p = f.properties || {}; const g = f.geometry;
      let layer = null;
      if (g?.type === 'Point') layer = L.marker([g.coordinates[1], g.coordinates[0]]);
      else if (g?.type === 'Polygon') layer = L.polygon(g.coordinates[0].map(c => [c[1], c[0]]));
      else if (p.center_lat && p.center_lng) layer = L.marker([p.center_lat, p.center_lng]);
      else if (p.latitude && p.longitude) layer = L.marker([p.latitude, p.longitude]);
      if (layer) group.addLayer(layer);
    });
    if (group.getLayers().length) map.fitBounds(group.getBounds(), { padding:[20,20] });
  }

  // ===== Modals =====
  function openCreateModal() {
    $('#zoneModalTitle').textContent = 'Create New Zone';
    $('#zoneForm').reset(); $('#zoneId').value = ''; currentGeometry = null; $('#coordinateInputs').style.display = 'none';
    $('#btnSaveZone').textContent = 'Save Zone';
    new bootstrap.Modal($('#zoneModal')).show();
    setTimeout(initDrawMap, 250);
  }

  function openEditModal(id) {
    const f = resolveById(id); if (!f) return notify('Zone not found','danger');
    const p = f.properties || {};

    $('#zoneModalTitle').textContent = 'Edit Zone';
    $('#zoneForm').reset();
    $('#zoneId').value = p.id ?? '';
    $('[name="name"]').value = p.name || '';
    $('[name="zone_type"]').value = p.zone_type || '';
    $('[name="description"]').value = p.description || '';
    $('[name="is_active"]').checked = !!p.is_active;
    $('#btnSaveZone').textContent = 'Update Zone';

    // geometry
    currentGeometry = f.geometry || null;
    if (!currentGeometry && p.center_lat && p.center_lng) {
      currentGeometry = { type: 'Point', coordinates: [p.center_lng, p.center_lat] };
      $('[name="center_lat"]').value = p.center_lat;
      $('[name="center_lng"]').value = p.center_lng;
      $('[name="radius_m"]').value = p.radius_m || p.radius || '';
      $('#coordinateInputs').style.display = '';
    }

    new bootstrap.Modal($('#zoneModal')).show();
    setTimeout(() => {
      initDrawMap();
      // show existing geometry
      if (!currentGeometry) return;
      let layer;
      if (currentGeometry.type === 'Point' && (p.radius_m || p.radius)) {
        const c = [currentGeometry.coordinates[1], currentGeometry.coordinates[0]];
        layer = L.circle(c, { radius: p.radius_m || p.radius });
      } else if (currentGeometry.type === 'Polygon') {
        const coords = currentGeometry.coordinates[0].map(v => [v[1], v[0]]);
        layer = L.polygon(coords);
      }
      if (layer) { drawnItems.addLayer(layer); drawMap.fitBounds(layer.getBounds()); }
    }, 250);
  }

  function openDeleteModal(id) { deleteId = id; new bootstrap.Modal($('#deleteModal')).show(); }

  async function onConfirmDelete() {
    if (!deleteId) return;
    try {
      const p = resolveById(deleteId)?.properties || {}; // optimistic name fetch
      const res = await fetch(API.remove(deleteId), { method: 'DELETE' });
      const j = await res.json();
      if (!res.ok || !j.success) throw new Error(j.error || `HTTP ${res.status}`);
      notify(`Deleted zone${p.name ? `: ${p.name}`:''}`,'success');
      loadZones();
    } catch (e) { notify('Error deleting zone','danger'); }
    finally { deleteId = null; bootstrap.Modal.getInstance($('#deleteModal')).hide(); }
  }

  // ===== Save =====
  async function onSaveZone() {
    const form = new FormData($('#zoneForm'));
    if (!currentGeometry) return notify('Please draw a zone on the map','warning');

    const payload = {
      name: form.get('name'),
      zone_type: form.get('zone_type'),
      description: form.get('description'),
      is_active: $('#isActiveSwitch').checked,
      status: 'approved'
    };

    if (currentGeometry.type === 'Point') {
      payload.center_lat = parseFloat(form.get('center_lat'));
      payload.center_lng = parseFloat(form.get('center_lng'));
      payload.radius_m  = parseInt(form.get('radius_m'));
    } else { payload.geometry = currentGeometry; }

    const id = form.get('zoneId');
    const url = id ? API.update(id) : API.create;
    const method = id ? 'PUT' : 'POST';

    try {
      const res = await fetch(url, { method, headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      const j = await res.json();
      if (!res.ok || !j.success) throw new Error(j.error || `HTTP ${res.status}`);
      notify(j.message || 'Zone saved','success');
      bootstrap.Modal.getInstance($('#zoneModal')).hide();
      loadZones();
    } catch (e) { notify('Error saving zone','danger'); }
  }

  // ===== Helpers =====
  function resolveById(id) {
    return allZones.find(f => String((f.properties||{}).id) === String(id));
  }

  function notify(msg, type='info') {
    const el = document.createElement('div');
    el.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    el.style.cssText = 'top:20px;right:20px;z-index:1055;min-width:280px;';
    el.innerHTML = `${escapeHtml(msg)}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(el); setTimeout(()=>{ el.remove(); }, 4000);
  }

  function setListLoading(loading) {
    $('#zonesList').style.opacity = loading ? .6 : 1;
  }

  function escapeHtml(s='') {
    return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  function getUserLocationMarker() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude:lat, longitude:lng } = pos.coords || {};
      if (!SG_BOUNDS.contains([lat,lng])) return; // only show if within SG
      const icon = L.divIcon({ className:'', html:'<i class="fas fa-user"></i>', iconSize:[16,16], iconAnchor:[8,8] });
      L.marker([lat,lng], { icon }).addTo(map).bindPopup('Your Location');
    }, () => {}, { enableHighAccuracy:false, timeout:8000, maximumAge:300000 });
  }
})();
</script>
{% endblock %}
