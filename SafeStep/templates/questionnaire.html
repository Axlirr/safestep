{% extends "base.html" %}

{% block title %}Health & Safety Questionnaire - SAFE-Step{% endblock %}

{% block body_class %}admin-page questionnaire-page{% endblock %}

{% block content %}
<div class="questionnaire-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="questionnaire-card">
                    <div class="questionnaire-header">
                        <div class="text-center mb-4">
                            <div class="questionnaire-logo mb-3">
                                <i class="fas fa-clipboard-list me-2"></i>SAFE-Step
                            </div>
                            <h2 class="questionnaire-title">Health & Safety Assessment</h2>
                            <p class="questionnaire-subtitle">Help us personalize your experience and provide better
                                support</p>
                        </div>

                        <!-- Progress Bar -->
                        <div class="progress-container mb-4">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                            </div>
                            <small class="text-muted mt-2 d-block text-center">
                                <span id="currentStep">1</span> of <span id="totalSteps">6</span> sections
                            </small>
                        </div>
                    </div>

                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
                        role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <form method="POST" id="questionnaireForm" class="needs-validation" novalidate>
                        <!-- Section 1: Personal Information -->
                        <div class="questionnaire-section" id="section1">
                            <h3 class="section-title">
                                <i class="fas fa-user me-2"></i>Personal Information
                            </h3>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="age" class="form-label">Age</label>
                                    <input type="number" class="form-control" id="age" name="age" min="1" max="120"
                                        required>
                                    <div class="invalid-feedback">Please enter your age.</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="gender" class="form-label">Gender</label>
                                    <select class="form-select" id="gender" name="gender" required>
                                        <option value="">Select gender...</option>
                                        <option value="M">Male</option>
                                        <option value="F">Female</option>
                                        <option value="Other">Other</option>
                                        <option value="Prefer not to say">Prefer not to say</option>
                                    </select>
                                    <div class="invalid-feedback">Please select your gender.</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="height_cm" class="form-label">Height (cm)</label>
                                    <input type="number" class="form-control" id="height_cm" name="height_cm" min="50"
                                        max="250" step="0.1">
                                    <div class="form-text">Optional - for health monitoring</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="weight_kg" class="form-label">Weight (kg)</label>
                                    <input type="number" class="form-control" id="weight_kg" name="weight_kg" min="10"
                                        max="300" step="0.1">
                                    <div class="form-text">Optional - for health monitoring</div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Medical History -->
                        <div class="questionnaire-section" id="section2" style="display: none;">
                            <h3 class="section-title">
                                <i class="fas fa-heartbeat me-2"></i>Medical History
                            </h3>
                            <div class="mb-3">
                                <label class="form-label">Do you have epilepsy?</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="has_epilepsy" id="epilepsy_yes"
                                        value="true">
                                    <label class="form-check-label" for="epilepsy_yes">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="has_epilepsy" id="epilepsy_no"
                                        value="false" checked>
                                    <label class="form-check-label" for="epilepsy_no">No</label>
                                </div>
                            </div>

                            <div id="epilepsy_details" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="epilepsy_diagnosis_age" class="form-label">Age at diagnosis</label>
                                        <input type="number" class="form-control" id="epilepsy_diagnosis_age"
                                            name="epilepsy_diagnosis_age" min="0" max="100">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="epilepsy_type" class="form-label">Type of epilepsy</label>
                                        <select class="form-select" id="epilepsy_type" name="epilepsy_type">
                                            <option value="">Select type...</option>
                                            <option value="focal">Focal</option>
                                            <option value="generalized">Generalized</option>
                                            <option value="combined">Combined</option>
                                            <option value="unknown">Unknown</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="seizure_frequency" class="form-label">Seizure frequency</label>
                                        <select class="form-select" id="seizure_frequency" name="seizure_frequency">
                                            <option value="">Select frequency...</option>
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="rare">Rare (few times per year)</option>
                                            <option value="none">No seizures currently</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="last_seizure_date" class="form-label">Last seizure date</label>
                                        <input type="date" class="form-control" id="last_seizure_date"
                                            name="last_seizure_date">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Medication & Treatment -->
                        <div class="questionnaire-section" id="section3" style="display: none;">
                            <h3 class="section-title">
                                <i class="fas fa-pills me-2"></i>Medication & Treatment
                            </h3>
                            <div class="mb-3">
                                <label for="current_medications" class="form-label">Current medications
                                    (optional)</label>
                                <textarea class="form-control" id="current_medications" name="current_medications"
                                    rows="3" placeholder="List any medications you're currently taking..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="medication_compliance" class="form-label">How well do you follow your
                                    medication schedule?</label>
                                <select class="form-select" id="medication_compliance" name="medication_compliance">
                                    <option value="">Select compliance level...</option>
                                    <option value="excellent">Excellent - Never miss doses</option>
                                    <option value="good">Good - Rarely miss doses</option>
                                    <option value="fair">Fair - Sometimes miss doses</option>
                                    <option value="poor">Poor - Often miss doses</option>
                                    <option value="not_applicable">Not applicable</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="medication_side_effects" class="form-label">Medication side effects
                                    (optional)</label>
                                <textarea class="form-control" id="medication_side_effects"
                                    name="medication_side_effects" rows="2"
                                    placeholder="Any side effects you experience..."></textarea>
                            </div>
                        </div>

                        <!-- Section 4: Lifestyle Factors -->
                        <div class="questionnaire-section" id="section4" style="display: none;">
                            <h3 class="section-title">
                                <i class="fas fa-running me-2"></i>Lifestyle Factors
                            </h3>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="sleep_hours_avg" class="form-label">Average hours of sleep per
                                        night</label>
                                    <select class="form-select" id="sleep_hours_avg" name="sleep_hours_avg">
                                        <option value="">Select hours...</option>
                                        <option value="4">Less than 5 hours</option>
                                        <option value="5">5-6 hours</option>
                                        <option value="7">6-8 hours</option>
                                        <option value="9">8-10 hours</option>
                                        <option value="11">More than 10 hours</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="stress_level" class="form-label">Stress level</label>
                                    <select class="form-select" id="stress_level" name="stress_level">
                                        <option value="">Select stress level...</option>
                                        <option value="low">Low</option>
                                        <option value="moderate">Moderate</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="exercise_frequency" class="form-label">Exercise frequency</label>
                                    <select class="form-select" id="exercise_frequency" name="exercise_frequency">
                                        <option value="">Select frequency...</option>
                                        <option value="never">Never</option>
                                        <option value="rarely">Rarely</option>
                                        <option value="weekly">1-3 times per week</option>
                                        <option value="daily">Daily or almost daily</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="alcohol_consumption" class="form-label">Alcohol consumption</label>
                                    <select class="form-select" id="alcohol_consumption" name="alcohol_consumption">
                                        <option value="">Select consumption...</option>
                                        <option value="none">None</option>
                                        <option value="occasional">Occasional</option>
                                        <option value="moderate">Moderate</option>
                                        <option value="heavy">Heavy</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Section 5: Safety & Support -->
                        <div class="questionnaire-section" id="section5" style="display: none;">
                            <h3 class="section-title">
                                <i class="fas fa-shield-alt me-2"></i>Safety & Support
                            </h3>
                            <div class="mb-3">
                                <label class="form-label">Do you live alone?</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="lives_alone" id="lives_alone_yes"
                                        value="true">
                                    <label class="form-check-label" for="lives_alone_yes">Yes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="lives_alone" id="lives_alone_no"
                                        value="false" checked>
                                    <label class="form-check-label" for="lives_alone_no">No</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="emergency_contact" class="form-label">Emergency contact name</label>
                                    <input type="text" class="form-control" id="emergency_contact"
                                        name="emergency_contact" placeholder="Full name">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="emergency_contact_phone" class="form-label">Emergency contact
                                        phone</label>
                                    <input type="tel" class="form-control" id="emergency_contact_phone"
                                        name="emergency_contact_phone" placeholder="Phone number">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Do you have a medical alert device?</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="has_medical_alert"
                                            id="medical_alert_yes" value="true">
                                        <label class="form-check-label" for="medical_alert_yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="has_medical_alert"
                                            id="medical_alert_no" value="false" checked>
                                        <label class="form-check-label" for="medical_alert_no">No</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Do you wear a helmet for safety?</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="wears_helmet" id="helmet_yes"
                                            value="true">
                                        <label class="form-check-label" for="helmet_yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="wears_helmet" id="helmet_no"
                                            value="false" checked>
                                        <label class="form-check-label" for="helmet_no">No</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 6: Technology & Monitoring -->
                        <div class="questionnaire-section" id="section6" style="display: none;">
                            <h3 class="section-title">
                                <i class="fas fa-mobile-alt me-2"></i>Technology & Monitoring
                            </h3>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="smartphone_usage" class="form-label">Smartphone usage</label>
                                    <select class="form-select" id="smartphone_usage" name="smartphone_usage">
                                        <option value="">Select usage level...</option>
                                        <option value="none">Don't use smartphone</option>
                                        <option value="basic">Basic usage (calls, texts)</option>
                                        <option value="advanced">Advanced usage (apps, internet)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Do you use wearable devices?</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="wearable_device"
                                            id="wearable_yes" value="true">
                                        <label class="form-check-label" for="wearable_yes">Yes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="wearable_device"
                                            id="wearable_no" value="false" checked>
                                        <label class="form-check-label" for="wearable_no">No</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="monitoring_preference" class="form-label">Preferred monitoring
                                    approach</label>
                                <select class="form-select" id="monitoring_preference" name="monitoring_preference">
                                    <option value="">Select preference...</option>
                                    <option value="continuous">Continuous monitoring</option>
                                    <option value="periodic">Periodic check-ins</option>
                                    <option value="manual">Manual logging only</option>
                                    <option value="none">No monitoring preferred</option>
                                </select>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="questionnaire-navigation">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                </button>
                                <button type="button" class="btn btn-primary" id="nextBtn">
                                    Next<i class="fas fa-arrow-right ms-2"></i>
                                </button>
                                <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                                    <i class="fas fa-check me-2"></i>Complete Assessment
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .questionnaire-page {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .questionnaire-container {
        margin-top: 2rem;
    }

    .questionnaire-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .questionnaire-header {
        border-bottom: 2px solid #f8f9fa;
        padding-bottom: 2rem;
        margin-bottom: 2rem;
    }

    .questionnaire-logo {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
    }

    .questionnaire-title {
        color: #333;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .questionnaire-subtitle {
        color: #666;
        font-size: 1.1rem;
    }

    .progress-container {
        max-width: 500px;
        margin: 0 auto;
    }

    .progress {
        height: 8px;
        border-radius: 10px;
        background-color: #e9ecef;
    }

    .progress-bar {
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .section-title {
        color: #333;
        font-weight: 600;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f8f9fa;
    }

    .questionnaire-section {
        margin-bottom: 2rem;
    }

    .questionnaire-navigation {
        border-top: 2px solid #f8f9fa;
        padding-top: 2rem;
        margin-top: 2rem;
    }

    .form-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .form-control,
    .form-select {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem;
        transition: border-color 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #6c757d;
        border: none;
    }

    .btn-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }

    .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
    }

    .alert {
        border-radius: 8px;
        border: none;
    }

    @media (max-width: 768px) {
        .questionnaire-card {
            padding: 1.5rem;
            margin: 1rem;
        }

        .questionnaire-navigation .d-flex {
            flex-direction: column;
            gap: 1rem;
        }

        .questionnaire-navigation .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentSection = 1;
    const totalSections = 6;

    document.addEventListener('DOMContentLoaded', function () {
        updateProgress();
        updateNavigation();

        // Handle epilepsy radio buttons
        document.querySelectorAll('input[name="has_epilepsy"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const epilepsyDetails = document.getElementById('epilepsy_details');
                if (this.value === 'true') {
                    epilepsyDetails.style.display = 'block';
                } else {
                    epilepsyDetails.style.display = 'none';
                }
            });
        });

        // Navigation buttons
        document.getElementById('nextBtn').addEventListener('click', nextSection);
        document.getElementById('prevBtn').addEventListener('click', prevSection);

        // Form validation
        document.getElementById('questionnaireForm').addEventListener('submit', function (e) {
            if (!validateCurrentSection()) {
                e.preventDefault();
                return false;
            }
        });
    });

    function nextSection() {
        if (validateCurrentSection()) {
            if (currentSection < totalSections) {
                document.getElementById('section' + currentSection).style.display = 'none';
                currentSection++;
                document.getElementById('section' + currentSection).style.display = 'block';
                updateProgress();
                updateNavigation();
            }
        }
    }

    function prevSection() {
        if (currentSection > 1) {
            document.getElementById('section' + currentSection).style.display = 'none';
            currentSection--;
            document.getElementById('section' + currentSection).style.display = 'block';
            updateProgress();
            updateNavigation();
        }
    }

    function updateProgress() {
        const progress = (currentSection / totalSections) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('currentStep').textContent = currentSection;
    }

    function updateNavigation() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        if (currentSection === 1) {
            prevBtn.style.display = 'none';
        } else {
            prevBtn.style.display = 'block';
        }

        if (currentSection === totalSections) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        } else {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        }
    }

    function validateCurrentSection() {
        const currentSectionElement = document.getElementById('section' + currentSection);
        const requiredFields = currentSectionElement.querySelectorAll('[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });

        if (!isValid) {
            // Scroll to first invalid field
            const firstInvalid = currentSectionElement.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        return isValid;
    }
</script>

<style>
    /* Fix input field styling for questionnaire */
    .questionnaire-page .form-control,
    .questionnaire-page .form-select {
        background-color: white !important;
        color: #000 !important;
        border: 2px solid #e1e5e9 !important;
        border-radius: 8px !important;
        padding: 12px 16px !important;
        font-size: 16px !important;
        transition: all 0.3s ease !important;
    }

    .questionnaire-page .form-control:focus,
    .questionnaire-page .form-select:focus {
        background-color: white !important;
        color: #000 !important;
        border-color: #4285f4 !important;
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1) !important;
        outline: none !important;
    }

    .questionnaire-page .form-control::placeholder {
        color: #6c757d !important;
    }

    .questionnaire-page .form-label {
        color: #000 !important;
        font-weight: 600 !important;
        margin-bottom: 8px !important;
    }

    .questionnaire-page .form-text {
        color: #6c757d !important;
        font-size: 14px !important;
    }

    .questionnaire-page .form-check-label {
        color: #000 !important;
    }

    .questionnaire-page .alert {
        background-color: white !important;
        color: #000 !important;
        border: 1px solid #e1e5e9 !important;
    }

    .questionnaire-page .alert-danger {
        background-color: #f8d7da !important;
        color: #721c24 !important;
        border-color: #f5c6cb !important;
    }

    .questionnaire-page .btn {
        background-color: #4285f4 !important;
        color: white !important;
        border: none !important;
        border-radius: 8px !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
    }

    .questionnaire-page .btn:hover {
        background-color: #3367d6 !important;
        color: white !important;
        transform: translateY(-2px) !important;
    }

    .questionnaire-page .btn-secondary {
        background-color: #6c757d !important;
    }

    .questionnaire-page .btn-secondary:hover {
        background-color: #5a6268 !important;
    }

    /* Progress bar styling */
    .questionnaire-page .progress {
        background-color: #e9ecef !important;
        border-radius: 10px !important;
        height: 8px !important;
    }

    .questionnaire-page .progress-bar {
        background-color: #4285f4 !important;
        border-radius: 10px !important;
    }

    /* Section styling */
    .questionnaire-page .section-title {
        color: #000 !important;
        font-weight: 700 !important;
        margin-bottom: 24px !important;
    }

    .questionnaire-page .questionnaire-title {
        color: #000 !important;
        font-weight: 800 !important;
    }

    .questionnaire-page .questionnaire-subtitle {
        color: #6c757d !important;
    }

    .questionnaire-page .questionnaire-logo {
        color: #4285f4 !important;
        font-size: 2rem !important;
        font-weight: 900 !important;
    }
</style>

{% endblock %}