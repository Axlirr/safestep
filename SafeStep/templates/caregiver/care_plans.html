{% extends "base.html" %}

{% block title %}Care Plans - Safe-Step{% endblock %}

{% block body_class %}caregiver-page{% endblock %}

{% block extra_css %}
<style>
    .care-plan-card {
        border-left: 4px solid var(--success-color);
        transition: all 0.3s ease;
    }
    .care-plan-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .goal-item {
        background: var(--gray-50);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid var(--primary-color);
    }
    .goal-completed {
        border-left-color: var(--success-color);
        background: var(--success-light);
    }
    .goal-overdue {
        border-left-color: var(--danger-color);
        background: var(--danger-light);
    }
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
    }
    .priority-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    .priority-high {
        background: var(--danger-color);
        color: white;
    }
    .priority-medium {
        background: var(--warning-color);
        color: white;
    }
    .priority-low {
        background: var(--info-color);
        color: white;
    }
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    .status-active {
        background: var(--success-color);
        color: white;
    }
    .status-completed {
        background: var(--primary-color);
        color: white;
    }
    .status-paused {
        background: var(--warning-color);
        color: white;
    }
    .status-cancelled {
        background: var(--gray-500);
        color: white;
    }
    .intervention-tag {
        background: var(--info-color);
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 0.7rem;
        margin: 2px;
        display: inline-block;
    }
    .timeline-item {
        border-left: 2px solid var(--gray-300);
        padding-left: 15px;
        margin-bottom: 15px;
        position: relative;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--primary-color);
    }
    .timeline-item.completed::before {
        background: var(--success-color);
    }
    .timeline-item.overdue::before {
        background: var(--danger-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="caregiver-container">
    <!-- Page Header -->
    <div class="caregiver-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-clipboard-list me-3"></i>Care Plans</h1>
                <p>Create and manage comprehensive care plans for your patients.</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCarePlanModal">
                    <i class="fas fa-plus me-2"></i>Create Care Plan
                </button>
                <button class="btn btn-outline-primary" onclick="refreshCarePlans()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="caregiver-stat-card">
                <div class="caregiver-stat-icon" style="background: var(--gradient-success);">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="caregiver-stat-value" id="totalCarePlans">0</div>
                <div class="caregiver-stat-label">Total Care Plans</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="caregiver-stat-card">
                <div class="caregiver-stat-icon" style="background: var(--gradient-primary);">
                    <i class="fas fa-play-circle"></i>
                </div>
                <div class="caregiver-stat-value" id="activeCarePlans">0</div>
                <div class="caregiver-stat-label">Active Plans</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="caregiver-stat-card">
                <div class="caregiver-stat-icon" style="background: var(--gradient-info);">
                    <i class="fas fa-bullseye"></i>
                </div>
                <div class="caregiver-stat-value" id="totalGoals">0</div>
                <div class="caregiver-stat-label">Total Goals</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="caregiver-stat-card">
                <div class="caregiver-stat-icon" style="background: var(--gradient-warning);">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="caregiver-stat-value" id="averageProgress">0%</div>
                <div class="caregiver-stat-label">Average Progress</div>
            </div>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchCarePlans" placeholder="Search care plans...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterStatus">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                        <option value="paused">Paused</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterPriority">
                        <option value="">All Priorities</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterProgress">
                        <option value="">All Progress</option>
                        <option value="0-25">0-25%</option>
                        <option value="26-50">26-50%</option>
                        <option value="51-75">51-75%</option>
                        <option value="76-100">76-100%</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Care Plans List -->
    <div class="card shadow">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Care Plans</h5>
        </div>
        <div class="card-body">
            <div id="carePlansContainer">
                <!-- Care plans will be loaded here -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading care plans...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Care Plan Modal -->
<div class="modal fade" id="addCarePlanModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Create New Care Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCarePlanForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="planName" class="form-label">Care Plan Name *</label>
                                <input type="text" class="form-control" id="planName" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority *</label>
                                <select class="form-select" id="priority" required>
                                    <option value="">Select priority</option>
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3" placeholder="Describe the care plan objectives and approach..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startDate" class="form-label">Start Date *</label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="targetEndDate" class="form-label">Target End Date</label>
                                <input type="date" class="form-control" id="targetEndDate">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Goals Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6><i class="fas fa-bullseye me-2"></i>Goals</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addGoal()">
                                <i class="fas fa-plus me-1"></i>Add Goal
                            </button>
                        </div>
                        <div id="goalsContainer">
                            <!-- Goals will be added here -->
                        </div>
                    </div>
                    
                    <!-- Interventions Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6><i class="fas fa-hands-helping me-2"></i>Interventions</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addIntervention()">
                                <i class="fas fa-plus me-1"></i>Add Intervention
                            </button>
                        </div>
                        <div id="interventionsContainer">
                            <!-- Interventions will be added here -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="notes" rows="3" placeholder="Any additional notes or special considerations..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCarePlan()">Create Care Plan</button>
            </div>
        </div>
    </div>
</div>

<!-- Care Plan Details Modal -->
<div class="modal fade" id="carePlanDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-clipboard-list me-2"></i>Care Plan Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="carePlanDetailsContent">
                <!-- Care plan details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editCarePlanBtn">Edit Plan</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allCarePlans = [];
let filteredCarePlans = [];
let goalCounter = 0;
let interventionCounter = 0;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set current date as default for start date
    document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
    
    loadCarePlans();
    loadStats();
    
    // Set up search and filter event listeners
    document.getElementById('searchCarePlans').addEventListener('input', filterCarePlans);
    document.getElementById('filterStatus').addEventListener('change', filterCarePlans);
    document.getElementById('filterPriority').addEventListener('change', filterCarePlans);
    document.getElementById('filterProgress').addEventListener('change', filterCarePlans);
});

// Load care plans
function loadCarePlans() {
    fetch('/api/enhanced/care-plans')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allCarePlans = data.care_plans;
                filteredCarePlans = [...allCarePlans];
                displayCarePlans(filteredCarePlans);
            } else {
                showError('Failed to load care plans: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error loading care plans:', error);
            showError('Failed to load care plans. Please try again.');
        });
}

// Display care plans
function displayCarePlans(carePlans) {
    const container = document.getElementById('carePlansContainer');
    
    if (carePlans.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No care plans found</h5>
                <p class="text-muted">Click "Create Care Plan" to get started.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = carePlans.map(plan => `
        <div class="care-plan-card card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-clipboard-list me-2 text-primary"></i>
                                ${plan.plan_name}
                            </h5>
                            <div>
                                <span class="priority-badge priority-${plan.priority}">
                                    ${plan.priority.toUpperCase()}
                                </span>
                                <span class="status-badge status-${plan.status} ms-2">
                                    ${plan.status.toUpperCase()}
                                </span>
                            </div>
                        </div>
                        
                        ${plan.description ? `<p class="text-muted mb-3">${plan.description}</p>` : ''}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <small class="text-muted"><strong>Start Date:</strong> ${new Date(plan.start_date).toLocaleDateString()}</small><br>
                                ${plan.target_end_date ? `<small class="text-muted"><strong>Target End:</strong> ${new Date(plan.target_end_date).toLocaleDateString()}</small>` : ''}
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted"><strong>Created:</strong> ${new Date(plan.created_at).toLocaleDateString()}</small><br>
                                <small class="text-muted"><strong>Last Updated:</strong> ${new Date(plan.updated_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                        
                        <!-- Goals Preview -->
                        ${plan.goals && plan.goals.length > 0 ? `
                            <div class="mb-3">
                                <h6 class="mb-2"><i class="fas fa-bullseye me-2"></i>Goals (${plan.goals.length})</h6>
                                <div class="row">
                                    ${plan.goals.slice(0, 2).map(goal => `
                                        <div class="col-md-6">
                                            <div class="goal-item ${goal.completed ? 'goal-completed' : (goal.target_date && new Date(goal.target_date) < new Date() ? 'goal-overdue' : '')}">
                                                <small><strong>${goal.goal_description}</strong></small><br>
                                                <small class="text-muted">Target: ${goal.target_date ? new Date(goal.target_date).toLocaleDateString() : 'No date set'}</small>
                                                ${goal.completed ? '<br><small class="text-success"><i class="fas fa-check me-1"></i>Completed</small>' : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${plan.goals.length > 2 ? `<div class="col-12"><small class="text-muted">+${plan.goals.length - 2} more goals...</small></div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Interventions Preview -->
                        ${plan.interventions && plan.interventions.length > 0 ? `
                            <div class="mb-2">
                                <small class="text-muted"><strong>Interventions:</strong></small><br>
                                ${plan.interventions.slice(0, 3).map(intervention => `
                                    <span class="intervention-tag">${intervention.intervention_type}</span>
                                `).join('')}
                                ${plan.interventions.length > 3 ? `<span class="intervention-tag">+${plan.interventions.length - 3} more</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <div class="progress progress-bar-custom mb-2">
                                <div class="progress-bar" role="progressbar" style="width: ${plan.progress_percentage}%" aria-valuenow="${plan.progress_percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted">${plan.progress_percentage}% Complete</small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-primary" onclick="viewCarePlanDetails('${plan.id}')">
                                <i class="fas fa-eye me-1"></i>View Details
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editCarePlan('${plan.id}')">
                                <i class="fas fa-edit me-1"></i>Edit Plan
                            </button>
                            ${plan.status === 'active' ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="pauseCarePlan('${plan.id}')">
                                    <i class="fas fa-pause me-1"></i>Pause
                                </button>
                            ` : plan.status === 'paused' ? `
                                <button class="btn btn-sm btn-outline-success" onclick="resumeCarePlan('${plan.id}')">
                                    <i class="fas fa-play me-1"></i>Resume
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Filter care plans
function filterCarePlans() {
    const searchTerm = document.getElementById('searchCarePlans').value.toLowerCase();
    const selectedStatus = document.getElementById('filterStatus').value;
    const selectedPriority = document.getElementById('filterPriority').value;
    const selectedProgress = document.getElementById('filterProgress').value;
    
    filteredCarePlans = allCarePlans.filter(plan => {
        const matchesSearch = !searchTerm || 
            plan.plan_name.toLowerCase().includes(searchTerm) ||
            (plan.description && plan.description.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !selectedStatus || plan.status === selectedStatus;
        const matchesPriority = !selectedPriority || plan.priority === selectedPriority;
        
        let matchesProgress = true;
        if (selectedProgress) {
            const [min, max] = selectedProgress.split('-').map(Number);
            matchesProgress = plan.progress_percentage >= min && plan.progress_percentage <= max;
        }
        
        return matchesSearch && matchesStatus && matchesPriority && matchesProgress;
    });
    
    displayCarePlans(filteredCarePlans);
}

// Clear filters
function clearFilters() {
    document.getElementById('searchCarePlans').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterPriority').value = '';
    document.getElementById('filterProgress').value = '';
    filteredCarePlans = [...allCarePlans];
    displayCarePlans(filteredCarePlans);
}

// Load statistics
function loadStats() {
    fetch('/api/enhanced/care-plans/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalCarePlans').textContent = data.stats.total_care_plans;
                document.getElementById('activeCarePlans').textContent = data.stats.active_care_plans;
                document.getElementById('totalGoals').textContent = data.stats.total_goals;
                document.getElementById('averageProgress').textContent = data.stats.average_progress + '%';
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

// Add goal to form
function addGoal() {
    goalCounter++;
    const goalsContainer = document.getElementById('goalsContainer');
    const goalHtml = `
        <div class="goal-item mb-3" id="goal-${goalCounter}">
            <div class="row">
                <div class="col-md-6">
                    <input type="text" class="form-control" placeholder="Goal description" name="goal_description_${goalCounter}" required>
                </div>
                <div class="col-md-4">
                    <input type="date" class="form-control" placeholder="Target date" name="goal_target_date_${goalCounter}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeGoal(${goalCounter})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    goalsContainer.insertAdjacentHTML('beforeend', goalHtml);
}

// Remove goal from form
function removeGoal(goalId) {
    document.getElementById(`goal-${goalId}`).remove();
}

// Add intervention to form
function addIntervention() {
    interventionCounter++;
    const interventionsContainer = document.getElementById('interventionsContainer');
    const interventionHtml = `
        <div class="goal-item mb-3" id="intervention-${interventionCounter}">
            <div class="row">
                <div class="col-md-4">
                    <select class="form-select" name="intervention_type_${interventionCounter}" required>
                        <option value="">Select type</option>
                        <option value="medication">Medication Management</option>
                        <option value="therapy">Physical Therapy</option>
                        <option value="monitoring">Health Monitoring</option>
                        <option value="education">Patient Education</option>
                        <option value="lifestyle">Lifestyle Modification</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" placeholder="Intervention description" name="intervention_description_${interventionCounter}" required>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeIntervention(${interventionCounter})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    interventionsContainer.insertAdjacentHTML('beforeend', interventionHtml);
}

// Remove intervention from form
function removeIntervention(interventionId) {
    document.getElementById(`intervention-${interventionId}`).remove();
}

// Save care plan
function saveCarePlan() {
    const form = document.getElementById('addCarePlanForm');
    const formData = new FormData(form);
    
    // Collect goals
    const goals = [];
    for (let i = 1; i <= goalCounter; i++) {
        const description = formData.get(`goal_description_${i}`);
        const targetDate = formData.get(`goal_target_date_${i}`);
        if (description) {
            goals.push({
                goal_description: description,
                target_date: targetDate || null
            });
        }
    }
    
    // Collect interventions
    const interventions = [];
    for (let i = 1; i <= interventionCounter; i++) {
        const type = formData.get(`intervention_type_${i}`);
        const description = formData.get(`intervention_description_${i}`);
        if (type && description) {
            interventions.push({
                intervention_type: type,
                description: description
            });
        }
    }
    
    const carePlanData = {
        plan_name: document.getElementById('planName').value,
        description: document.getElementById('description').value || null,
        priority: document.getElementById('priority').value,
        start_date: document.getElementById('startDate').value,
        target_end_date: document.getElementById('targetEndDate').value || null,
        goals: goals,
        interventions: interventions,
        notes: document.getElementById('notes').value || null
    };
    
    fetch('/api/enhanced/care-plans', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(carePlanData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Care plan created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('addCarePlanModal')).hide();
            resetCarePlanForm();
            loadCarePlans();
            loadStats();
        } else {
            showError('Failed to create care plan: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving care plan:', error);
        showError('Failed to save care plan. Please try again.');
    });
}

// Reset care plan form
function resetCarePlanForm() {
    document.getElementById('addCarePlanForm').reset();
    document.getElementById('goalsContainer').innerHTML = '';
    document.getElementById('interventionsContainer').innerHTML = '';
    goalCounter = 0;
    interventionCounter = 0;
}

// View care plan details
function viewCarePlanDetails(carePlanId) {
    const plan = allCarePlans.find(p => p.id === carePlanId);
    if (!plan) return;
    
    const content = `
        <div class="row mb-4">
            <div class="col-md-8">
                <h4>${plan.plan_name}</h4>
                <p class="text-muted">${plan.description || 'No description provided'}</p>
            </div>
            <div class="col-md-4 text-end">
                <span class="priority-badge priority-${plan.priority} me-2">${plan.priority.toUpperCase()}</span>
                <span class="status-badge status-${plan.status}">${plan.status.toUpperCase()}</span>
                <div class="mt-2">
                    <div class="progress progress-bar-custom">
                        <div class="progress-bar" style="width: ${plan.progress_percentage}%"></div>
                    </div>
                    <small class="text-muted">${plan.progress_percentage}% Complete</small>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <h6><i class="fas fa-calendar me-2"></i>Timeline</h6>
                <p><strong>Start Date:</strong> ${new Date(plan.start_date).toLocaleDateString()}</p>
                ${plan.target_end_date ? `<p><strong>Target End Date:</strong> ${new Date(plan.target_end_date).toLocaleDateString()}</p>` : ''}
                <p><strong>Created:</strong> ${new Date(plan.created_at).toLocaleDateString()}</p>
                <p><strong>Last Updated:</strong> ${new Date(plan.updated_at).toLocaleDateString()}</p>
            </div>
            <div class="col-md-6">
                ${plan.notes ? `
                    <h6><i class="fas fa-sticky-note me-2"></i>Notes</h6>
                    <p>${plan.notes}</p>
                ` : ''}
            </div>
        </div>
        
        ${plan.goals && plan.goals.length > 0 ? `
            <div class="mb-4">
                <h6><i class="fas fa-bullseye me-2"></i>Goals (${plan.goals.length})</h6>
                <div class="timeline">
                    ${plan.goals.map(goal => `
                        <div class="timeline-item ${goal.completed ? 'completed' : (goal.target_date && new Date(goal.target_date) < new Date() ? 'overdue' : '')}">
                            <h6>${goal.goal_description}</h6>
                            <p class="text-muted mb-1">Target: ${goal.target_date ? new Date(goal.target_date).toLocaleDateString() : 'No date set'}</p>
                            ${goal.completed ? '<p class="text-success mb-0"><i class="fas fa-check me-1"></i>Completed</p>' : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        ${plan.interventions && plan.interventions.length > 0 ? `
            <div class="mb-4">
                <h6><i class="fas fa-hands-helping me-2"></i>Interventions (${plan.interventions.length})</h6>
                <div class="row">
                    ${plan.interventions.map(intervention => `
                        <div class="col-md-6 mb-3">
                            <div class="goal-item">
                                <h6>${intervention.intervention_type.replace('_', ' ').toUpperCase()}</h6>
                                <p class="mb-0">${intervention.description}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
    `;
    
    document.getElementById('carePlanDetailsContent').innerHTML = content;
    document.getElementById('editCarePlanBtn').onclick = () => editCarePlan(carePlanId);
    
    const modal = new bootstrap.Modal(document.getElementById('carePlanDetailsModal'));
    modal.show();
}

// Refresh care plans
function refreshCarePlans() {
    loadCarePlans();
    loadStats();
    showSuccess('Care plans refreshed!');
}

// Utility functions
function showSuccess(message) {
    alert('Success: ' + message);
}

function showError(message) {
    alert('Error: ' + message);
}

function editCarePlan(carePlanId) {
    alert('Edit functionality coming soon!');
}

function pauseCarePlan(carePlanId) {
    alert('Pause functionality coming soon!');
}

function resumeCarePlan(carePlanId) {
    alert('Resume functionality coming soon!');
}
</script>
{% endblock %}