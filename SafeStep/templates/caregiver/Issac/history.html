{% extends "base.html" %}

{% block title %}Seizure History - Safe-Step{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-history me-2"></i>Seizure History
                    </h1>
                    <p class="text-muted mb-0">Complete record of all monitoring sessions and seizure events</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                        <i class="fas fa-download me-2"></i>Export Data
                    </button>
                    <button class="btn btn-success" onclick="window.location.href='{{ url_for('seizure_monitoring') }}';">
                        <i class="fas fa-plus me-2"></i>New Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-0">{{ sessions|length }}</h3>
                            <p class="mb-0">Total Sessions</p>
                        </div>
                        <i class="fas fa-calendar-alt fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-0">{{ sessions|selectattr('severity', 'equalto', 'severe')|list|length }}</h3>
                            <p class="mb-0">Severe Episodes</p>
                        </div>
                        <i class="fas fa-exclamation-triangle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-0">7</h3>
                            <p class="mb-0">Days Since Last</p>
                        </div>
                        <i class="fas fa-clock fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h3 class="mb-0">85%</h3>
                            <p class="mb-0">Prediction Accuracy</p>
                        </div>
                        <i class="fas fa-brain fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="dateRange" class="form-label">Date Range</label>
                            <select class="form-select" id="dateRange" onchange="filterSessions()">
                                <option value="all">All Time</option>
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 3 months</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="severityFilter" class="form-label">Severity</label>
                            <select class="form-select" id="severityFilter" onchange="filterSessions()">
                                <option value="all">All Severities</option>
                                <option value="mild">Mild</option>
                                <option value="moderate">Moderate</option>
                                <option value="severe">Severe</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="locationFilter" class="form-label">Location</label>
                            <input type="text" class="form-control" id="locationFilter" placeholder="Filter by location" onkeyup="filterSessions()">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times me-2"></i>Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sessions Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Session History
                    </h5>
                    <div class="d-flex align-items-center gap-2">
                        <small class="text-muted">Show:</small>
                        <select class="form-select form-select-sm" id="pageSize" onchange="updatePageSize()" style="width: auto;">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    {% if sessions %}
                        <div class="table-responsive">
                            <table class="table table-hover" id="sessionsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th class="sortable" onclick="sortTable(0)">
                                            Date & Time <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" onclick="sortTable(1)">
                                            Duration <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th class="sortable" onclick="sortTable(2)">
                                            Severity <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <!-- Removed Patient column -->
                                        <th class="sortable" onclick="sortTable(4)">
                                            Location <i class="fas fa-sort ms-1"></i>
                                        </th>
                                        <th>Triggers</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in sessions %}
                                    <tr data-session-id="{{ session.id }}">
                                        <td>
                                            <div>
                                                <strong>{{ session.start_time.strftime('%m/%d/%Y') }}</strong><br>
                                                <small class="text-muted">{{ session.start_time.strftime('%I:%M %p') }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            {% if session.end_time %}
                                                {% set duration = (session.end_time - session.start_time).total_seconds()|int %}
                                                <span class="badge bg-secondary">{{ duration }} sec</span>
                                            {% else %}
                                                <span class="badge bg-warning">Ongoing</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if session.severity == 'severe' else 'warning' if session.severity == 'moderate' else 'info' }}">
                                                {{ session.severity|title if session.severity else 'Monitoring' }}
                                            </span>
                                        </td>
                                        <!-- Removed Patient cell -->
                                        <td>
                                            <i class="fas fa-map-marker-alt me-1 text-muted"></i>
                                            {{ session.location or 'Unknown' }}
                                        </td>
                                        <td>
                                            {% if session.triggers %}
                                                <span class="text-truncate" style="max-width: 150px;" title="{{ session.triggers }}">
                                                    {{ session.triggers[:50] }}{{ '...' if session.triggers|length > 50 else '' }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">None</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if session.notes %}
                                                <span class="text-truncate" style="max-width: 150px;" title="{{ session.notes }}">
                                                    {{ session.notes[:50] }}{{ '...' if session.notes|length > 50 else '' }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">None</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('session_detail', session_id=session.id) }}" class="btn btn-sm btn-outline-primary" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button class="btn btn-sm btn-outline-success" onclick="exportSession('{{ session.id }}')" title="Export">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSession('{{ session.id }}')" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Sessions pagination" class="mt-3">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be generated by JavaScript -->
                            </ul>
                        </nav>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list text-muted mb-3" style="font-size: 4rem;"></i>
                            <h4 class="text-muted">No Sessions Found</h4>
                            <p class="text-muted mb-4">You haven't recorded any monitoring sessions yet.</p>
                            <a href="{{ url_for('seizure_monitoring') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Start Your First Session
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Session Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label class="form-label">Export Format</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="format" id="formatPDF" value="pdf" checked>
                            <label class="form-check-label" for="formatPDF">
                                <i class="fas fa-file-pdf me-2 text-danger"></i>PDF Report
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="format" id="formatCSV" value="csv">
                            <label class="form-check-label" for="formatCSV">
                                <i class="fas fa-file-csv me-2 text-success"></i>CSV Spreadsheet
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="format" id="formatJSON" value="json">
                            <label class="form-check-label" for="formatJSON">
                                <i class="fas fa-file-code me-2 text-info"></i>JSON Data
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="exportDateRange" class="form-label">Date Range</label>
                        <select class="form-select" id="exportDateRange">
                            <option value="all">All Sessions</option>
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 3 months</option>
                            <option value="365">Last year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="mb-3 d-none" id="customDateRange">
                        <div class="row">
                            <div class="col-6">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-6">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeNotes" checked>
                            <label class="form-check-label" for="includeNotes">
                                Include notes and observations
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeCharts">
                            <label class="form-check-label" for="includeCharts">
                                Include charts and graphs (PDF only)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="exportData()">
                    <i class="fas fa-download me-2"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let sessionsPerPage = 25;
let sortColumn = 0;
let sortDirection = 'desc';

document.addEventListener('DOMContentLoaded', function() {
    setupPagination();
    
    // Custom date range toggle
    document.getElementById('exportDateRange').addEventListener('change', function() {
        const customRange = document.getElementById('customDateRange');
        if (this.value === 'custom') {
            customRange.classList.remove('d-none');
        } else {
            customRange.classList.add('d-none');
        }
    });
});

function filterSessions() {
    const dateRange = document.getElementById('dateRange').value;
    const severity = document.getElementById('severityFilter').value;
    const location = document.getElementById('locationFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('#sessionsTable tbody tr');
    
    rows.forEach(row => {
        let showRow = true;
        
        // Date filter
        if (dateRange !== 'all') {
            const dateCell = row.cells[0].textContent;
            const sessionDate = new Date(dateCell);
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(dateRange));
            
            if (sessionDate < cutoffDate) {
                showRow = false;
            }
        }
        
        // Severity filter
        if (severity !== 'all') {
            const severityCell = row.cells[2].textContent.toLowerCase();
            if (!severityCell.includes(severity.toLowerCase())) {
                showRow = false;
            }
        }
        
        // Location filter
        if (location) {
            const locationCell = row.cells[3].textContent.toLowerCase();
            if (!locationCell.includes(location)) {
                showRow = false;
            }
        }
        
        row.style.display = showRow ? '' : 'none';
    });
    
    setupPagination();
}

function clearFilters() {
    document.getElementById('dateRange').value = 'all';
    document.getElementById('severityFilter').value = 'all';
    document.getElementById('locationFilter').value = '';
    
    // Show all rows
    const rows = document.querySelectorAll('#sessionsTable tbody tr');
    rows.forEach(row => {
        row.style.display = '';
    });
    
    setupPagination();
}

function sortTable(columnIndex) {
    const table = document.getElementById('sessionsTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.style.display !== 'none');
    
    // Toggle sort direction
    if (sortColumn === columnIndex) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortDirection = 'asc';
        sortColumn = columnIndex;
    }
    
    rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent.trim();
        let bValue = b.cells[columnIndex].textContent.trim();
        
        // Handle date sorting
        if (columnIndex === 0) {
            aValue = new Date(aValue).getTime();
            bValue = new Date(bValue).getTime();
        }
        
        if (sortDirection === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort indicators
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort ms-1';
    });
    
    const currentIcon = document.querySelectorAll('.sortable')[columnIndex].querySelector('i');
    currentIcon.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'} ms-1`;
}

function setupPagination() {
    const rows = document.querySelectorAll('#sessionsTable tbody tr[style=""], #sessionsTable tbody tr:not([style])');
    const totalRows = rows.length;
    const totalPages = Math.ceil(totalRows / sessionsPerPage);
    
    // Hide/show rows based on current page
    rows.forEach((row, index) => {
        const startIndex = (currentPage - 1) * sessionsPerPage;
        const endIndex = startIndex + sessionsPerPage;
        
        if (index >= startIndex && index < endIndex) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Generate pagination controls
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages > 1) {
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + (currentPage - 1) + ')">Previous</a>';
        pagination.appendChild(prevLi);
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a>';
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + (currentPage + 1) + ')">Next</a>';
        pagination.appendChild(nextLi);
    }
}

function changePage(page) {
    if (page < 1) return;
    currentPage = page;
    setupPagination();
}

function updatePageSize() {
    sessionsPerPage = parseInt(document.getElementById('pageSize').value);
    currentPage = 1;
    setupPagination();
}

function deleteSession(sessionId) {
    if (confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
        fetch('/caregiver/history', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ session_id: sessionId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete session: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error deleting session: ' + error);
        });
    }
}

function exportSession(sessionId) {
    // In a real app, this would generate and download the session data
    alert(`Exporting session #${sessionId}...`);
}

function exportData() {
    const format = document.querySelector('input[name="format"]:checked').value;
    const dateRange = document.getElementById('exportDateRange').value;
    const includeNotes = document.getElementById('includeNotes').checked;
    const includeCharts = document.getElementById('includeCharts').checked;
    
    // In a real app, this would generate and download the export file
    const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
    modal.hide();
    
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    alert.innerHTML = `
        Export generated successfully! Download will start shortly.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 3000);
}
</script>
{% endblock %}