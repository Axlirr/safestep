{% extends "base.html" %}

{% block title %}Safety Zones - SAFE-Step{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
/* Caregiver Zones Styles */
.zones-header {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 25px 25px;
}

.zones-title {
    font-size: 2.5rem;
    font-weight: 900;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.zone-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    border: 1px solid #e2e8f0;
    margin-bottom: 1.5rem;
}

.zone-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.12);
}

.map-container {
    height: 500px;
    border-radius: 15px;
    border: 2px solid #e2e8f0;
    margin-bottom: 1rem;
}

.zone-type-badge {
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.85rem;
}

.zone-type-safe {
    background: #f0fff4;
    color: #38a169;
    border: 1px solid #38a169;
}

.zone-type-danger {
    background: #fff5f5;
    color: #e53e3e;
    border: 1px solid #e53e3e;
}

.btn-request {
    background: linear-gradient(135deg, #3182ce 0%, #63b3ed 100%);
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-request:hover {
    background: linear-gradient(135deg, #63b3ed 0%, #3182ce 100%);
    color: white;
    transform: translateY(-2px);
}

.leaflet-container {
    border-radius: 15px;
}

.singapore-info {
    background: #e6fffa;
    border: 1px solid #81e6d9;
    color: #234e52;
    padding: 0.75rem;
    border-radius: 8px;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.stats-card {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    border: none;
    box-shadow: 0 8px 25px rgba(17, 153, 142, 0.3);
}

.stats-number {
    font-size: 2rem;
    font-weight: 900;
    margin-bottom: 0.5rem;
}

.zone-list-item {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 4px solid #e2e8f0;
    transition: all 0.3s ease;
    cursor: pointer;
}

.zone-list-item:hover {
    background: #f1f5f9;
    border-left-color: #11998e;
}

.zone-list-item.safe {
    border-left-color: #48bb78;
}

.zone-list-item.danger {
    border-left-color: #f56565;
}
</style>
{% endblock %}

{% block content %}
<!-- Zones Header -->
<div class="zones-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="zones-title mb-2">Safety Zones</h1>
                <p class="mb-0" style="font-size: 1.1rem; opacity: 0.9;">
                    View approved safety zones across Singapore
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="/caregiver/sai/zone-request" class="btn btn-request">
                    <i class="fas fa-plus me-2"></i>Request New Zone
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Statistics Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-number" id="totalZones">0</div>
                <div>Total Zones</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-number" id="safeZones">0</div>
                <div>Safe Zones</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-number" id="dangerZones">0</div>
                <div>Danger Zones</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-number" id="nearbyZones">0</div>
                <div>Nearby Zones</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Map View -->
        <div class="col-lg-8">
            <div class="zone-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Singapore Zone Map</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="locateMe()">
                            <i class="fas fa-crosshairs me-1"></i>My Location
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="centerOnSingapore()">
                            <i class="fas fa-map me-1"></i>View All
                        </button>
                    </div>
                </div>
                
                <div class="singapore-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Read-Only View:</strong> These are approved safety zones. You can request new zones using the button above.
                </div>
                
                <div id="zonesMap" class="map-container"></div>
            </div>
        </div>

        <!-- Zone List -->
        <div class="col-lg-4">
            <div class="zone-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Active Zones</h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshZones()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                
                <div id="zonesList" class="zones-list">
                    <!-- Zones will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Caregiver Zones JavaScript
let map;
let zonesLayer;
let zones = [];
let userLocation = null;

// Singapore bounds
const SINGAPORE_BOUNDS = [
    [1.16, 103.6],   // Southwest
    [1.47, 104.0]    // Northeast
];

document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    loadZones();
    getUserLocation();
});

function initializeMap() {
    map = L.map('zonesMap').setView([1.3521, 103.8198], 11);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // Restrict map to Singapore bounds
    map.setMaxBounds(SINGAPORE_BOUNDS);
    map.options.minZoom = 10;
    
    // Create layer for zones
    zonesLayer = L.layerGroup().addTo(map);
}

function loadZones() {
    fetch('/api/zones')
        .then(response => response.json())
        .then(data => {
            zones = data.features || [];
            displayZones();
            displayZonesList();
            updateStatistics();
        })
        .catch(error => {
            console.error('Error loading zones:', error);
            // Load demo zones if API fails
            loadDemoZones();
        });
}

function loadDemoZones() {
    zones = [
        {
            type: "Feature",
            properties: {
                id: 1,
                name: "Marina Bay Safe Zone",
                description: "Safe area around Marina Bay Sands for supervised activities",
                zone_type: "safe",
                radius_m: 200,
                is_active: true,
                created_at: "2025-01-08T10:00:00Z"
            },
            geometry: {
                type: "Point",
                coordinates: [103.8589, 1.2864]
            }
        },
        {
            type: "Feature",
            properties: {
                id: 2,
                name: "Jurong Industrial Danger Zone",
                description: "High-risk industrial area with restricted access",
                zone_type: "danger",
                is_active: true,
                created_at: "2025-01-08T11:00:00Z"
            },
            geometry: {
                type: "Polygon",
                coordinates: [[
                    [103.7094, 1.3321],
                    [103.7194, 1.3321],
                    [103.7194, 1.3221],
                    [103.7094, 1.3221],
                    [103.7094, 1.3321]
                ]]
            }
        },
        {
            type: "Feature",
            properties: {
                id: 3,
                name: "Changi Airport Safe Zone",
                description: "Designated safe area at Changi Airport Terminal 3",
                zone_type: "safe",
                radius_m: 100,
                is_active: true,
                created_at: "2025-01-08T12:00:00Z"
            },
            geometry: {
                type: "Point",
                coordinates: [103.9915, 1.3644]
            }
        }
    ];
    
    displayZones();
    displayZonesList();
    updateStatistics();
}

function displayZones() {
    zonesLayer.clearLayers();
    
    zones.forEach(zone => {
        const geometry = zone.geometry;
        const properties = zone.properties;
        
        let layer;
        
        if (geometry.type === 'Point') {
            // Circle zone
            const center = [geometry.coordinates[1], geometry.coordinates[0]];
            const radius = properties.radius_m || 50;
            
            layer = L.circle(center, {
                radius: radius,
                color: properties.zone_type === 'safe' ? '#38a169' : '#e53e3e',
                fillColor: properties.zone_type === 'safe' ? '#38a169' : '#e53e3e',
                fillOpacity: 0.2,
                weight: 2
            });
            
        } else if (geometry.type === 'Polygon') {
            // Polygon zone
            const coordinates = geometry.coordinates[0].map(coord => [coord[1], coord[0]]);
            
            layer = L.polygon(coordinates, {
                color: properties.zone_type === 'safe' ? '#38a169' : '#e53e3e',
                fillColor: properties.zone_type === 'safe' ? '#38a169' : '#e53e3e',
                fillOpacity: 0.2,
                weight: 2
            });
        }
        
        if (layer) {
            // Add popup
            layer.bindPopup(`
                <div class="text-center">
                    <h6 class="mb-2">${properties.name}</h6>
                    <span class="badge zone-type-${properties.zone_type}">${properties.zone_type.toUpperCase()}</span>
                    <p class="small mt-2 mb-0">${properties.description || 'No description'}</p>
                    <div class="small text-muted mt-1">
                        Created: ${new Date(properties.created_at).toLocaleDateString()}
                    </div>
                </div>
            `);
            
            zonesLayer.addLayer(layer);
        }
    });
}

function displayZonesList() {
    const zonesList = document.getElementById('zonesList');
    
    if (zones.length === 0) {
        zonesList.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                <p class="mb-0">No zones found</p>
                <small>No approved zones available yet</small>
            </div>
        `;
        return;
    }
    
    const zonesHtml = zones.map(zone => {
        const props = zone.properties;
        const distance = userLocation ? calculateDistance(userLocation, zone) : null;
        
        return `
            <div class="zone-list-item ${props.zone_type}" onclick="focusZone(${props.id})">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${props.name}</h6>
                        <span class="badge zone-type-${props.zone_type} mb-2">${props.zone_type.toUpperCase()}</span>
                        <p class="small text-muted mb-1">${props.description || 'No description'}</p>
                        <div class="small text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            ${new Date(props.created_at).toLocaleDateString()}
                            ${distance ? `<br><i class="fas fa-map-marker-alt me-1"></i>${distance}` : ''}
                        </div>
                    </div>
                    <div>
                        <i class="fas fa-eye text-primary" title="View on map"></i>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    zonesList.innerHTML = zonesHtml;
}

function updateStatistics() {
    const safeCount = zones.filter(z => z.properties.zone_type === 'safe').length;
    const dangerCount = zones.filter(z => z.properties.zone_type === 'danger').length;
    const nearbyCount = userLocation ? zones.filter(z => {
        const dist = calculateDistanceKm(userLocation, z);
        return dist && dist <= 5; // Within 5km
    }).length : 0;
    
    document.getElementById('totalZones').textContent = zones.length;
    document.getElementById('safeZones').textContent = safeCount;
    document.getElementById('dangerZones').textContent = dangerCount;
    document.getElementById('nearbyZones').textContent = nearbyCount;
}

function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Add user location marker if within Singapore
                if (isWithinSingaporeBounds(userLocation.lat, userLocation.lng)) {
                    const userIcon = L.divIcon({
                        className: 'user-marker',
                        html: '<i class="fas fa-user" style="color: #3182ce; font-size: 16px;"></i>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
                        .addTo(map)
                        .bindPopup('Your Location');
                }
                
                // Update statistics with nearby zones
                updateStatistics();
                displayZonesList();
            },
            function(error) {
                console.log('Location access denied or unavailable:', error);
            },
            {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 300000
            }
        );
    }
}

function calculateDistance(userLocation, zone) {
    if (!userLocation) return null;
    
    const distanceKm = calculateDistanceKm(userLocation, zone);
    if (!distanceKm) return null;
    
    if (distanceKm < 1) {
        return `${Math.round(distanceKm * 1000)}m away`;
    } else {
        return `${distanceKm.toFixed(1)}km away`;
    }
}

function calculateDistanceKm(userLocation, zone) {
    if (!userLocation) return null;
    
    let targetLat, targetLng;
    
    if (zone.geometry.type === 'Point') {
        targetLat = zone.geometry.coordinates[1];
        targetLng = zone.geometry.coordinates[0];
    } else if (zone.geometry.type === 'Polygon') {
        // Calculate centroid
        const coords = zone.geometry.coordinates[0];
        targetLat = coords.reduce((sum, coord) => sum + coord[1], 0) / coords.length;
        targetLng = coords.reduce((sum, coord) => sum + coord[0], 0) / coords.length;
    } else {
        return null;
    }
    
    const R = 6371; // Earth's radius in km
    const dLat = (targetLat - userLocation.lat) * Math.PI / 180;
    const dLng = (targetLng - userLocation.lng) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(userLocation.lat * Math.PI / 180) * Math.cos(targetLat * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    
    return R * c;
}

function isWithinSingaporeBounds(lat, lng) {
    return (lat >= 1.16 && lat <= 1.47) && (lng >= 103.6 && lng <= 104.0);
}

function focusZone(zoneId) {
    const zone = zones.find(z => z.properties.id === zoneId);
    if (!zone) return;
    
    if (zone.geometry.type === 'Point') {
        const center = [zone.geometry.coordinates[1], zone.geometry.coordinates[0]];
        map.setView(center, 15);
    } else if (zone.geometry.type === 'Polygon') {
        const coords = zone.geometry.coordinates[0].map(coord => [coord[1], coord[0]]);
        const group = new L.featureGroup([L.polygon(coords)]);
        map.fitBounds(group.getBounds(), { padding: [20, 20] });
    }
    
    // Find and open popup
    zonesLayer.eachLayer(layer => {
        if (layer.getPopup && layer.getPopup().getContent().includes(zone.properties.name)) {
            layer.openPopup();
        }
    });
}

function locateMe() {
    if (userLocation && isWithinSingaporeBounds(userLocation.lat, userLocation.lng)) {
        map.setView([userLocation.lat, userLocation.lng], 14);
        showNotification('Centered on your location', 'success');
    } else {
        getUserLocation();
        showNotification('Trying to get your location...', 'info');
    }
}

function centerOnSingapore() {
    map.setView([1.3521, 103.8198], 11);
}

function refreshZones() {
    loadZones();
    showNotification('Zones refreshed', 'success');
}

function showNotification(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}
</script>
{% endblock %}